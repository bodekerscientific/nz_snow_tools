"""
code to plot maps of snow covered area for individual years from summary lists generated by catchment_evalutation.py
"""

from __future__ import division

import numpy as np
import pickle
import matplotlib.pylab as plt
from nz_snow_tools.util.utils import trim_data_to_mask, resample_to_fsca

rl = 4  # resample length (i.e. how many grid cells in each direction to resample.
which_model = 'dsc_snow'  # string identifying the model to be run. options include 'clark2009', 'dsc_snow', or 'all' # future will include 'fsm'
model_catchment = 'Clutha'
output_dem = 'nztm250m'  # identifier for output dem
years_to_take = range(2000, 2016 + 1)  # [2013 + 1]  # range(2001, 2013 + 1)
model_swe_sc_threshold = 20  # threshold for treating a grid cell as snow covered
model_output_folder = 'P:/Projects/DSC-Snow/runs/output/clutha_nztm250m_erebus'
plot_folder = 'P:/Projects/DSC-Snow/runs/output/clutha_nztm250m_erebus/plots'

output_subcatchments = ['Clutha', 'Wilkin', 'Wanaka northern inflows', 'Upper Dart', 'Rees', 'Shotover', 'Teviot', 'Taieri', 'Upper Matukituki', 'Roaring Meg', \
                        'Pomahaka', 'Motutapu', 'Moonlight Creek', 'Matukituki', 'Manuherikia', 'Luggate Creek', 'Lochy', 'Lindis', \
                        'Kawarau', 'Greenstone', 'Hawea', 'Fraser', 'Clutha above Clyde Dam', 'Cardrona', 'Arrow', 'Bannockburn Creek', 'Nevis']
mask_folder = 'T:/DSC-Snow/Masks'

run_id = 'jobst_ucc_5_topleft'  # string identifying fortran dsc_snow run. everything after the year
# run_ids = [ ,'norton_5_topleft', 'vcsn_5_topleft']  # ,

# for run_id in run_ids:

ann = pickle.load(open(model_output_folder + '/resample_fit_{}_swe{}_{}_rs{}.pkl'.format(model_catchment, model_swe_sc_threshold, run_id, rl), 'rb'))
s_obs = ann[0]
s_mod = ann[1]
s_ns = ann[2]
s_bias = ann[3]
s_rmse = ann[4]
s_mae = ann[5]

plt.figure(figsize=(10,8))

plt.subplot(2, 3, 1)
cmap = plt.cm.viridis
cmap.set_bad('0.5')
plt.imshow(np.mean(s_obs, axis=0), origin=0, interpolation='none', vmin=0, vmax=100)
plt.colorbar()
plt.title('mean fsca MODIS')

plt.subplot(2, 3, 2)
plt.imshow(np.mean(s_mod, axis=0), origin=0, interpolation='none', vmin=0, vmax=100)
plt.colorbar()
plt.title('mean fsca MODEL (SWE thres= {}'.format(model_swe_sc_threshold))

plt.subplot(2, 3, 3)
cmap = plt.cm.RdBu
cmap.set_bad('0.5')
plt.imshow(np.mean(s_bias, axis=0), origin=0, interpolation='none', vmin=-50, vmax=50, cmap=cmap)  # , vmin=0, vmax=365, cmap='viridis')
plt.colorbar()
plt.title('Mean Bias (mod-obs)')

plt.subplot(2, 3, 4)
cmap = plt.cm.RdBu
# cmap.set_bad('0.5')
plt.imshow(np.mean(s_ns, axis=0), origin=0, interpolation='none', vmin=-1, vmax=1, cmap=cmap)  # , vmin=0, vmax=365, cmap='viridis')
plt.colorbar()
plt.title('Nash-Sutcliffe')

plt.subplot(2, 3, 5)
cmap = plt.cm.viridis
# cmap.set_bad('0.5')
plt.imshow(np.mean(s_rmse, axis=0), origin=0, interpolation='none', cmap=cmap)  # , vmin=0, vmax=365, cmap='viridis')
plt.colorbar()
plt.title('RMSE')

plt.subplot(2, 3, 6)
cmap = plt.cm.viridis
# cmap.set_bad('0.5')
plt.imshow(np.mean(s_mae, axis=0), origin=0, interpolation='none', cmap=cmap)  # , vmin=0, vmax=365, cmap='viridis')
plt.colorbar()
plt.title('MAE')

plt.tight_layout()
plt.savefig(
    plot_folder + '/fsca_fit_{}_swe{}_{}_rs{}.png'.format(model_catchment, model_swe_sc_threshold, run_id, rl), dpi=300)
plt.close()
